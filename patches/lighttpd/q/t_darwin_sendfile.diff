Subject: [PATCH] network_backends.h: support darwin sendfile

The FreeBSD version of sendfile is already supported.  Starting
with OS X 10.5, Darwin also supports sendfile, but using a
slightly different argument list.

Add support for darwin's sendfile by introducing a suitable
macro to adjust the arguments.

Signed-off-by: Kyle J. McKay <mackyle@gmail.com>

---
 src/network_backends.h | 15 ++++++++++++++-
 1 file changed, 14 insertions(+), 1 deletion(-)

diff --git a/src/network_backends.h b/src/network_backends.h
index 5813253a..f2ec58bb 100644
--- a/src/network_backends.h
+++ b/src/network_backends.h
@@ -15,9 +15,22 @@
 # include <sys/uio.h>
 #endif
 
-#if defined HAVE_SYS_UIO_H && defined HAVE_SENDFILE && defined HAVE_WRITEV && (defined(__FreeBSD__) || defined(__DragonFly__))
+#if defined HAVE_SYS_UIO_H && defined HAVE_SENDFILE && defined HAVE_WRITEV && (defined(__FreeBSD__) || defined(__DragonFly__) || defined(__APPLE__))
 # define USE_FREEBSD_SENDFILE
 # include <sys/uio.h>
+# ifdef __APPLE__
+#  include <sys/types.h>
+#  include <sys/socket.h>
+#  include <limits.h>
+#  ifndef UIO_MAXIOV
+#   define UIO_MAXIOV IOV_MAX
+#  endif
+   static __inline int _darwin_sendfile(
+    int fd, int s, off_t offset, off_t *len, struct sf_hdtr *hdtr, int flags)
+    {return sendfile(fd, s, offset, len, hdtr, flags);}
+#  define sendfile(fd, s, offset, nbytes, hdtr, sbytes, flags) \
+    ((*sbytes)=(off_t)(nbytes),_darwin_sendfile(fd, s, offset, sbytes, hdtr, flags))
+# endif
 #endif
 
 #if defined HAVE_SYS_SENDFILE_H && defined HAVE_SENDFILEV && defined HAVE_WRITEV && defined(__sun)
-- 
tg: (4e2815a7..) t/darwin/sendfile (depends on: release)
